---
title: "12_fNIRS"
author: "Amanda Yumi"
date: "5 de novembro de 2018"
output: html_document
weight: 120
---

# Espectroscopia do infravermelho próximo.

A espectroscopia do infravermelho próximo em funcionamento - fNIRs é uma tecnologia de neuroimagem para mapear o córtex humano, que desde 1977, é empregada para o mapeamento do cérebro de humanos e em animais através de sua oxigenação (Jobsis, 1977). Os tecidos humanos são relativamente transparentes à luz na janela espectral NIR, que é absorvida por compostos pigmentados (cromóforos) ou dispersa em tecidos (Ferrari, 2012). A luz NIR é capaz de penetrar nos tecidos humanos, uma vez que o fator dominante no seu transporte de tecido é a dispersão. A imagem em infravermelho próximo ou a imagem óptica difusa são utilizadas para detectar mudanças simultâneas nas propriedades ópticas do córtex humano a partir de múltiplos locais de medição e exibe os resultados na forma de um mapa ou imagem em uma área específica.

Atividade cerebral está associada a um número de eventos fisiológicos, alguns associados a mudanças nas propriedades ópticas do tecido cerebral e podem ser avaliadas por técnicas ópticas. As principais vantagens dos métodos ópticos incluem custo relativamente baixo, a especificidade bioquímica, a resolução temporal (na faixa de milissegundos), o potencial para medir simultaneamente os eventos intracelulares e intravasculares e a facilidade com que os dispositivos podem ser transportados (Ferrari, 2012).

Segundo Delpy (10997), utiliza-se níveis seguros de luz laser (com comprimentos de onda entre 650 e 1000 nm) para inferir a variação do nível de oxigenação do tecido cerebral de forma não invasiva, que penetram no tecido biológico e atingem o córtex, permitindo analisar a oxi-hemoglobina (O2Hb), deoxi-hemoglobina (HHb) e hemoglobina total (tHb; tHb = O2Hb + HHb) do sangue cerebral. Muitos outros cromóforos ainda absorvem a luz mas apenas essas são de importância clínica e exibem absorção dependente da oxigenação. Através delas pode-se buscar um melhor entendimento do acoplamento neuro-vascular, das flutuações neurofisiológicas e da hemodinâmica cerebral.

A técnica NIRs utiliza:

* Diodo laser e/ou fontes de luz de diodos emissores de luz que abrangem a janela óptica entre 650 e 1000 nm
*	Fibra óptica flexível para transportar a luz NIR da fonte e detector tecidos

Três tipos de NIRS diferentes são usadas, cada uma baseada em um tipo específico de iluminação:

* A modalidade CW (\textit{continuous wave} ou ondas contínuas) que, com base na constante iluminação do tecido, mede a atenuação da luz através da cabeça. Essa modalidade mede apenas as alterações de oxigenação de O2Hb e HHb mas em relação às outras técnicas, oferece as vantagens de baixo custo e facilidade de transporte.

* O método de freqüência-domínio (FD) que, iluminando a cabeça com luz modulada por intensidade, mede a atenuação e o atraso de fase da luz emergente.

* A técnica do domínio do tempo (TD) que, iluminando a cabeça com pulsos de luz curtos, detecta a forma do pulso após a propagação através dos tecidos.


As modalidades FD e TD oferecem a possibilidade de caracterizar as propriedades ópticas dos tecidos (absorção e coeficientes de espalhamento reduzidos), dos quais é possível recuperar as concentrações absolutas de O2Hb e HHb.

As fibras ópticas são muito adequadas para qualquer posição e postura da cabeça. As medições de NIRS podem ser realizadas em ambientes naturais sem necessidade de restrição ou sedação e a profundidade adequada da penetração da luz NIR (quase a metade da distância do detector fonte) pode ser alcançada usando uma distância do detector em torno de 3cm. A seleção da distância ideal do detector de fonte depende da intensidade da luz NIR e do comprimento de onda, da idade do sujeito e a região da cabeça medida (Ferrari, 2012).

À medida que a luz injetada se difunde em todas as direções dentro dos tecidos da cabeça (couro cabeludo, crânio e espaço subaracnóideo preenchido com líquido cefalorraquidiano) tanto antes como depois de passar pelo tecido cerebral, a sensibilidade de cada par de fontes-detectores exibe uma distribuição espacial da luz NIR através das diferentes camadas com formato similar ao de uma banana (duas extremidades estreitas e uma curva para dentro em direção ao centro).

A atenuação relativamente alta da luz NIR no tecido é devida à hemoglobina principal do cromóforo (a proteína dos glóbulos vermelhos que faz o transporte de oxigênio) localizada em pequenos vasos ($<1 mm$ de diâmetro) da microcirculação, como leitos capilares, arteriolares e venulares . NIRS é fracamente sensível aos vasos sanguíneos $> 1mm$ porque absorvem completamente a luz.

Conforme apresentado por (Mesquita, 2008), O tecido biológico é altamente espalhador de luz e possui coeficientes de absorção relativamente baixos na região do infravermelho próximo do espectro eletromagnético. Estas propriedades permitem a penetração da luz no tecido e sua conseqüente propagação por alguns milímetros, através dos coeficientes de absorção $\mu_{a}$) e de espalhamento ($\mu_s$) com valores típicos para estas grandezas no cérebro $\mu_a = 1,4 cm^{-1}$ e $s = 350 cm^{-1}$. Com, $\mu_a$ variando significativamente com a concentração e o tipo de hemoglobina presente no tecido. É esta sensibilidade das propriedades ópticas da oxi-hemoglobina (O2Hb) e da deoxihemoglobina (HHb), aliada ao fato de ser baixo o coeficiente de absorção da água nessa região, que permite determinar os níveis de oxigenação do tecido com base no espalhamento de luz.

Durante ativação cerebral (Mesquita2008), as variações nas concentrações de O2Hb e HHb resultam em variações na absorção da luz dentro do tecido. Para medidas hemodinâmicas funcionais típicas, assume-se que essas variações são pequenas, insuficientes para perturbar o caminho da luz através do tecido podendo ser generalizada através da Lei de Beer-Lambert:

$ \Delta OD_i(t, \lambda) = L_{i,j} (\lambda) \sum_{j=1}^{N_{vox}}\Delta\mu_{a,j}(t, \lambda) .
$

onde, $OD$ é a densidade óptica num detector $i$, $j$ é a fonte, $\lambda$ é o comprimento da onda, $\mu_a$ é o coeficiente de absorção do tecido e $L_{i,j}$ é o livre caminho médio no tecido biológico entre a fonte e detector (na ordem de 28 $\mu m$).

No entanto, essa equação só é válida na ausência de espalhamento. Como o caminho médio da luz depende das propriedades de espalhamento do tecido, usa-se a lei de Beer-Lambert modificada,  (MBLL, do inglês \textit{modified Beer-Lambert law}) para contabilizar estes efeitos e levar em conta a propagação difusiva da luz, que inclui um fator de caminho diferencial adicional ($l_{DPF}$), de forma que $OD$ passa a ser dada por:

$
\Delta OD_i(t, \lambda) = \sum_{n}\mathcal{E}_n(\lambda).\Delta c_n(t).L_{i,j} (\lambda).l_{DPF}(\lambda)
$

onde a variação de concentração do n-ésimo cromóforo, $\Delta C_n$, pode ser encontrada através de medidas de intensidade em função do tempo para n diferentes comprimentos de onda. No caso particular de $n=2$, pode-se resolver o sistema e estimar as variações de O2Hb(t) e de HHb(t). Com isso, pode-se ver o coeficiente de extinção, distância entre emissor e detector, propriedades do tecido, etc.

Os experimentos de NIRS, no entanto, medem apenas as variações relativas de oxigenação do tecido. Os valores absolutos não são disponíveis, principalmente levando-se em consideração as diferentes estruturas cerebrais pelas quais a luz atravessa. Outras limitações também são: (a) a interferência da espessura do crânio (medidas cerebrais) ou da espessura do tecido adiposo (medidas musculares); (b) a contribuição controversa desconhecida da mioglobina no sinal muscular NIRS; (c) o efeito do volume sanguíneo muda no comprimento do tecido e, consequentemente no volume de amostra observado; (d) a dificuldade de prever o quanto de uma mudança de sinal NIRS observada é devido ao fluxo sanguíneo cerebral vs. couro cabeludo, ou (e) mudanças simultâneas no fluxo e no volume. Ainda assim, dado o fato de que a fração do volume de sangue arterial é de aproximadamente 30\% no cérebro humano, a técnica NIRS oferece a possibilidade de obter informações sobre alterações de oxigenação que ocorrem dentro do compartimento venoso, sendo uma técnica bastante eficaz para detectar zonas de ativação cerebral.

Ao longo do tempo, o que se altera nos dados de fNIRS é a variação de oxyhemoglobina e deoxyhemoglobina.

No caso da coleta, o canal é o caminho entre o emissor e o detector. A montagem é escolhida de forma a varrer as regiões cerebrais as quais se pretende estudar (aprox 3cm).

<div align="center">
   <iframe width="560" height="315" src="http://www.youtube.com/watch?v=CJIZkZ2ol5A" frameborder="0" allowfullscreen>
   </iframe>
</div>

<div align="center">
   <iframe width="560" height="315" src="http://www.youtube.com/watch?v=3LMXiDzcANQ" frameborder="0" allowfullscreen>
   </iframe>
</div>


### Realizando a leitura dos dados de fNIRS no R:

```{r}
# Os dados já foram preprocessados
# - PCA para correcao de movimento
# - retirar outliers
# - filtro temporal: passa-banda (0.001-0.1Hz)

#Leitura de dados
OXY=read.table("Oxy781HZ30sBlock.txt",header=F)
DEOXY=read.table("Deoxy781HZ30sBlock.txt",header=F)
```

Analisando o tamanho do arquivo e a taxa de amostragem:

```{r}
# Taxa de amostragem do equipamento
HZ = 7.81

dim(OXY)
dim(DEOXY)

# Logo, temos de tempo de coleta:
tempo = dim(OXY)/HZ
tempo

ts.plot(OXY[, 1])
ts.plot(DEOXY[, 1])

#Tarefa block-design - 30s
COND = 330
```

Considerando uma tarefa nas seguintes condições:
R: 1: 234
T: 235:469
R: 470: 703
T: 704: 937
R: 938: 1172
T: 1173:1406
R: 1407:1640
T: 1641:1874
R: 1875:2109
T: 2110:2343
R: 2344:2577


```{r}
#Tarefa block-design - 30s
COND=array(0, 2577) #2577 para os primeiros 330s
COND[235:469]=1
COND[704:937]=1
COND[1173:1406]=1
COND[1641:1874]=1
COND[2110:2343]=1
ts.plot(COND)
```

Considerando a função glover para convolução pela HRF canônica, para verificar como a Oxyhemoglobina se comporta.

Para prever o desenho experimental pela HRF, similar às aulas de ressonância:

```{r}
glover=function(HZ){
	a1=6
	a2=12
	b1=0.9
	b2=0.9
	d1=5.4
	d2=10.8
	c=0.35
	x=seq(0, 30, 1/HZ) # HZ is the Sampling Rate (Heartz)
	glover1=((x/d1)^a1)*exp((-x+d1)/b1)
	glover2=((x/d2)^a2)*exp((-x+d2)/b2)
	G=glover1-c*glover2
	return(G)
}

#HRF canonica
HRF=glover(HZ)

#Convolucao da condicao da tarefa pela HRF
X=filter(COND,HRF,method="convolution",side=1)
ts.plot(X)
```
Para o comportamento da deoxy, espero o comportamento inverso (deoxy está negativamente correlacionada com a oxy).

Estamos modelando de forma similar:
$$ Y_t = \alpha + \beta.X_t + \epsilon_T$$

```{r}
# Vetor que contem as estatisticas t dos betas
# do GLM para cada canal (nesse experimento são 20)
mapaToxy = array(0, 20)
mapaTdeoxy = array(0, 20)

for(canal in 1:20){
  #ajuste do GLM para oxy
  modelo = lm(OXY[1:2577, canal]~X)
  mapaToxy[canal] = summary(modelo)$coef[2, 3] #estat. t
  
  #ajuste do GLM para deoxy
  modelo = lm(DEOXY[1:2577,canal]~X)
  mapaTdeoxy[canal] = summary(modelo)$coef[2, 3] #estat. t
}
```

Uma consideração do GLM é que os erros (resíduos) são independentes. Na prática, como a taxa de amostragem do NIRS é superior a do fMRI, o problema da autocorrelação dos resíduos é maior. Para mapas de ativação estatísticos, os procedimentos de pre-whitening, pre-colouring ou semi-paramétricos são necessários
pois os valores de teste T do NIRS acabam com uma magnitude muito maior. 














